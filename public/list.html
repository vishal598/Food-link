<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Available Donations - FoodLink</title>
  <link rel="stylesheet" href="/page.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4CAF50;
      --primary-dark: #388E3C;
      --accent: #8BC34A;
      --dark: #111;
      --darker: #000;
      --light: #fff;
      --gray: #aaa;
      --transition: all 0.3s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }
    
    body {
      background: var(--darker);
      color: var(--light);
      line-height: 1.6;
    }
    
    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 5%;
      background: rgba(17, 17, 17, 0.95);
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      box-shadow: 0 2px 15px rgba(0, 0, 0, 0.3);
    }
    
    nav .logo {
      font-size: 2rem;
      font-weight: 700;
      color: var(--light);
      display: flex;
      align-items: center;
      text-decoration: none;
    }
    
    nav .logo::before {
      content: "";
      display: inline-block;
      height: 30px;
      width: 30px;
      background-color: var(--primary);
      margin-right: 10px;
      border-radius: 50%;
    }
    
    nav .menu {
      display: flex;
      gap: 30px;
    }
    
    nav .menu a {
      color: var(--light);
      text-decoration: none;
      font-weight: 500;
      font-size: 1.1rem;
      position: relative;
      transition: var(--transition);
    }
    
    nav .menu a::after {
      content: '';
      position: absolute;
      width: 0;
      height: 3px;
      background: var(--primary);
      left: 0;
      bottom: -5px;
      transition: var(--transition);
    }
    
    nav .menu a:hover {
      color: var(--primary);
    }
    
    nav .menu a:hover::after {
      width: 100%;
    }
    
    .container {
      max-width: 1200px;
      margin: 120px auto 50px;
      padding: 0 20px;
    }
    
    .page-header {
      text-align: center;
      margin-bottom: 50px;
    }
    
    .page-header h1 {
      font-size: 2.5rem;
      margin-bottom: 15px;
      position: relative;
      display: inline-block;
      padding-bottom: 10px;
    }
    
    .page-header h1::after {
      content: '';
      position: absolute;
      width: 60px;
      height: 3px;
      background: var(--primary);
      left: 50%;
      bottom: 0;
      transform: translateX(-50%);
    }

    .page-header p {
      color: var(--gray);
      max-width: 600px;
      margin: 0 auto;
    }
    
    .filter-section {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      background: var(--dark);
      padding: 20px;
      border-radius: 10px;
    }
    
    .filter-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .filter-btn {
      padding: 8px 15px;
      background: transparent;
      color: var(--light);
      border: 1px solid var(--primary);
      border-radius: 20px;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .filter-btn.active,
    .filter-btn:hover {
      background: var(--primary);
      color: var(--light);
    }
    
    .search-container {
      display: flex;
      margin-top: 15px;
    }
    
    .search-input {
      padding: 10px 15px;
      border: none;
      border-radius: 5px 0 0 5px;
      background: rgba(255, 255, 255, 0.1);
      color: var(--light);
      width: 250px;
    }
    
    .search-input:focus {
      outline: none;
    }
    
    .search-btn {
      background: var(--primary);
      color: var(--light);
      border: none;
      border-radius: 0 5px 5px 0;
      padding: 0 15px;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .search-btn:hover {
      background: var(--primary-dark);
    }
    
    .donations-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 30px;
      margin-bottom: 50px;
    }
    
    .donation-card {
      background: var(--dark);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      border: 1px solid rgba(255, 255, 255, 0.05);
      height: 100%;
      display: flex;
      flex-direction: column;
    }
    
    .donation-card:hover {
      transform: translateY(-10px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
      border-color: rgba(76, 175, 80, 0.3);
    }
    
    .donation-image {
      height: 200px;
      background-size: cover;
      background-position: center;
      position: relative;
    }
    
    .food-image {
      background-image: url('https://images.unsplash.com/photo-1504674900247-0877df9cc836?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80');
    }
    
    .grocery-image {
      background-image: url('https://images.unsplash.com/photo-1542838132-92c53300491e?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80');
    }
    
    .pet-food-image {
      background-image: url('https://images.unsplash.com/photo-1548767797-d8c844163c4c?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80');
    }
    
    .clothing-image {
      background-image: url('https://images.unsplash.com/photo-1489987707025-afc232f7ea0f?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80');
    }
    
    .donation-badge {
      position: absolute;
      top: 15px;
      right: 15px;
      padding: 5px 12px;
      background: var(--primary);
      color: var(--light);
      font-size: 0.8rem;
      font-weight: 600;
      border-radius: 20px;
    }

    .donation-details {
      padding: 24px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .donation-details h3 {
      font-size: 1.4rem;
      margin-bottom: 12px;
      color: var(--light);
      font-weight: 600;
      line-height: 1.3;
    }
    
    .donation-meta {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      color: var(--gray);
      font-size: 0.9rem;
    }
    
    .detail-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .detail-label {
      font-weight: 500;
      color: var(--gray);
    }
    
    .detail-value {
      color: var(--light);
    }
    
    .donation-description {
      margin: 15px 0;
      color: #ddd;
      line-height: 1.5;
    }
    
    .donation-info {
      display: flex;
      justify-content: space-between;
      padding-top: 15px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .info-item {
      display: flex;
      align-items: center;
      font-size: 0.9rem;
    }
    
    .info-item i {
      color: var(--primary);
      margin-right: 5px;
    }
    
    .request-btn {
      display: block;
      width: 100%;
      padding: 12px;
      margin-top: 15px;
      background: var(--primary);
      color: var(--light);
      text-align: center;
      text-decoration: none;
      border: none;
      border-radius: 5px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .request-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 50px;
    }
    
    .pagination-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 5px;
      background: var(--dark);
      color: var(--light);
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: var(--transition);
    }
    
    .pagination-btn.active,
    .pagination-btn:hover {
      background: var(--primary);
    }
    
    @media (max-width: 768px) {
      .filter-section {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .search-container {
        width: 100%;
        margin-top: 20px;
      }
      
      .search-input {
        width: 100%;
      }
      
      nav .menu {
        display: none;
      }
    }
    
    /* Additional Styles for Loading and Modal */
    .loading-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 50px 0;
      color: var(--gray);
      font-size: 1.2rem;
      grid-column: 1 / -1;
    }
    
    .loading-indicator i {
      font-size: 3rem;
      margin-bottom: 20px;
      color: var(--primary);
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1100;
      justify-content: center;
      align-items: center;
    }
    
    .modal-content {
      background: var(--dark);
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      position: relative;
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .close-modal {
      position: absolute;
      top: 15px;
      right: 20px;
      font-size: 1.5rem;
      color: var(--gray);
      cursor: pointer;
      transition: var(--transition);
    }
    
    .close-modal:hover {
      color: var(--primary);
    }
    
    .modal-content h2 {
      margin-bottom: 10px;
      font-size: 1.8rem;
    }
    
    .modal-content p {
      color: var(--gray);
      margin-bottom: 20px;
    }
    
    .modal-input-group {
      margin-bottom: 15px;
    }
    
    .modal-input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .modal-input-group input,
    .modal-input-group textarea {
      width: 100%;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 5px;
      color: var(--light);
      font-size: 1rem;
      transition: var(--transition);
    }
    
    .modal-input-group input:focus,
    .modal-input-group textarea:focus {
      border-color: var(--primary);
      outline: none;
    }
    
    .modal-submit-btn {
      width: 100%;
      padding: 12px;
      background: var(--primary);
      color: var(--light);
      border: none;
      border-radius: 5px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      margin-top: 15px;
    }
    
    .modal-submit-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .no-donations {
      grid-column: 1 / -1;
      text-align: center;
      padding: 50px 20px;
      background: var(--dark);
      border-radius: 10px;
    }
    
    .no-donations h3 {
      margin-bottom: 10px;
      font-size: 1.8rem;
    }
    
    .no-donations p {
      color: var(--gray);
      margin-bottom: 20px;
    }
    
    .btn-donate-now {
      display: inline-block;
      padding: 10px 20px;
      background: var(--primary);
      color: var(--light);
      text-decoration: none;
      border-radius: 5px;
      font-weight: 600;
      transition: var(--transition);
    }
    
    .btn-donate-now:hover {
      background: var(--primary-dark);
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    /* User dropdown menu */
    .user-menu-container {
      position: relative;
      display: none;
    }
    
    .user-menu-button {
      color: var(--light);
      text-decoration: none;
      font-weight: 500;
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    
    .user-menu-button:after {
      content: '\f107';
      font-family: 'Font Awesome 5 Free';
      font-weight: 900;
      margin-left: 5px;
    }
    
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: var(--dark);
      min-width: 160px;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      z-index: 1001;
      border-radius: 5px;
      overflow: hidden;
    }
    
    .dropdown-content a {
      color: var(--light);
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      transition: background-color 0.3s;
    }
    
    .dropdown-content a:hover {
      background-color: var(--primary-dark);
    }
    
    .show {
      display: block;
    }
    
    /* Enhance the tracking info display */
    .tracking-info {
      margin: 18px 0;
      padding: 12px 15px;
      background: rgba(76, 175, 80, 0.1);
      border-radius: 8px;
      border-left: 3px solid var(--primary);
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .tracking-info:hover {
      background: rgba(76, 175, 80, 0.15);
      transform: translateY(-2px);
    }
    
    .tracking-info .info-item {
      justify-content: center;
      margin-bottom: 5px;
    }
    
    .tracking-info .info-item i {
      color: var(--primary);
      margin-right: 8px;
    }
    
    .tracking-info a {
      color: var(--primary);
      display: block;
      margin-top: 5px;
      font-size: 0.9rem;
      text-decoration: none;
      transition: all 0.3s ease;
    }
    
    .tracking-info a:hover {
      color: var(--primary-dark);
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <nav>
    <a href="page.html" class="logo">FoodLink</a>
    <div class="menu">
      <a href="page.html#about">About</a>
      <a href="page.html#contacts">Contact</a>
      <a href="page.html#report">Report</a>
      <a href="signup.html" id="signupLink">Sign Up</a>
      <a href="index.html" id="loginLink">Login</a>
      <a href="tracking.html"><i class="fas fa-search"></i> Track Donation</a>
      <a href="update-tracking.html"><i class="fas fa-edit"></i> Update Status</a>
      <div class="user-menu-container" id="userMenuContainer">
        <span class="user-menu-button" id="userMenuButton" onclick="toggleDropdown()"></span>
        <div class="dropdown-content" id="userDropdown">
          <a href="#profile">My Profile</a>
          <a href="#history">Donation History</a>
          <a href="#settings">Settings</a>
          <a href="#" onclick="logout()">Logout</a>
        </div>
      </div>
      <a href="page.html" class="highlight">Donate Now</a>
    </div>
  </nav>

  <div class="container">
    <div class="page-header">
      <h1>Available Donations</h1>
      <p>Browse through the list of items donated by our generous community. Request items for your organization or shelter.</p>
    </div>

    <div class="filter-section">
      <div class="filter-controls">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="Food">Food</button>
        <button class="filter-btn" data-filter="Pet Food">Pet Food</button>
        <button class="filter-btn" data-filter="Groceries">Groceries</button>
        <button class="filter-btn" data-filter="Clothing">Clothing</button>
      </div>
      <div class="search-container">
        <input type="text" class="search-input" placeholder="Search for items...">
        <button class="search-btn"><i class="fas fa-search"></i></button>
      </div>
    </div>

    <div class="donations-grid" id="donationsGrid">
      <!-- Donation cards will be dynamically inserted here -->
      <div class="loading-indicator">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Loading donations...</p>
      </div>
    </div>

    <div class="pagination">
      <button class="pagination-btn active">1</button>
      <button class="pagination-btn">2</button>
      <button class="pagination-btn">3</button>
      <button class="pagination-btn"><i class="fas fa-ellipsis-h"></i></button>
      <button class="pagination-btn">10</button>
    </div>
  </div>

  <!-- Request Donation Modal -->
  <div class="modal" id="requestModal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2>Request Donation</h2>
      <p>Please provide your information to request this donation.</p>
      <form id="requestForm">
        <input type="hidden" id="donationId" name="donationId">
        <div class="modal-input-group">
          <label for="requesterName">Your Name</label>
          <input type="text" id="requesterName" name="requesterName" required>
        </div>
        <div class="modal-input-group">
          <label for="requesterEmail">Email Address</label>
          <input type="email" id="requesterEmail" name="requesterEmail" required>
        </div>
        <div class="modal-input-group">
          <label for="requesterPhone">Phone Number</label>
          <input type="tel" id="requesterPhone" name="requesterPhone" required>
        </div>
        <div class="modal-input-group">
          <label for="requesterMessage">Message to Donor</label>
          <textarea id="requesterMessage" name="requesterMessage" rows="3"></textarea>
        </div>
        <button type="submit" class="modal-submit-btn">Submit Request</button>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // User authentication functionality
      const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
      const currentUser = localStorage.getItem('currentUser');
      
      // Update navigation based on login status
      updateNavigation(isLoggedIn, currentUser);
      
      // Function to update navigation
      function updateNavigation(isLoggedIn, username) {
        const loginLink = document.getElementById('loginLink');
        const signupLink = document.getElementById('signupLink');
        const userMenuContainer = document.getElementById('userMenuContainer');
        const userMenuButton = document.getElementById('userMenuButton');
        
        if (isLoggedIn && username) {
          // Hide login/signup links
          loginLink.style.display = 'none';
          signupLink.style.display = 'none';
          
          // Show user menu
          userMenuContainer.style.display = 'block';
          userMenuButton.textContent = username;
        } else {
          // Show login/signup links
          loginLink.style.display = 'inline-block';
          signupLink.style.display = 'inline-block';
          
          // Hide user menu
          userMenuContainer.style.display = 'none';
        }
      }
      
      // Function to handle logout
      window.logout = function() {
        // Clear login status
        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('currentUser');
        
        // Update navigation
        updateNavigation(false, null);
        
        // Close dropdown
        document.getElementById('userDropdown').classList.remove('show');
        
        // Redirect to logout endpoint
        window.location.href = '/logout';
      };
      
      // Function to toggle dropdown
      window.toggleDropdown = function() {
        document.getElementById('userDropdown').classList.toggle('show');
      };
      
      // Close dropdown when clicking outside
      window.onclick = function(event) {
        if (!event.target.matches('#userMenuButton')) {
          const dropdowns = document.getElementsByClassName('dropdown-content');
          for (let i = 0; i < dropdowns.length; i++) {
            const openDropdown = dropdowns[i];
            if (openDropdown.classList.contains('show')) {
              openDropdown.classList.remove('show');
            }
          }
        }

        // Also handle the modal
        if (event.target === document.getElementById('requestModal')) {
          document.getElementById('requestModal').style.display = 'none';
        }
      };
      
      // DOM Elements
      const donationsGrid = document.querySelector('.donations-grid');
      const filterButtons = document.querySelectorAll('.filter-btn');
      const searchInput = document.querySelector('.search-input');
      const searchBtn = document.querySelector('.search-btn');
      const modal = document.getElementById('requestModal');
      const closeModal = document.querySelector('.close-modal');
      const requestForm = document.getElementById('requestForm');
      
      // Initialize donations array
      let donations = [];
      let filteredDonations = [];
      
      // Fetch donations from server
      function fetchDonations() {
        // Show loading indicator
        donationsGrid.innerHTML = `
          <div class="loading-indicator">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Loading donations...</p>
          </div>
        `;
        
        fetch('/donations')
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to fetch donations');
            }
            return response.json();
          })
          .then(data => {
            donations = data;
            filteredDonations = [...donations];
            renderDonations();
          })
          .catch(error => {
            console.error('Error fetching donations:', error);
            donationsGrid.innerHTML = `
              <div class="no-donations">
                <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #d9534f; margin-bottom: 15px;"></i>
                <h3>Error Loading Donations</h3>
                <p>There was a problem fetching the donations. Please try again later.</p>
              </div>
            `;
          });
      }
      
      // Render donations function
      function renderDonations() {
        // Clear the grid
        donationsGrid.innerHTML = '';
        
        // If no donations after filtering
        if (filteredDonations.length === 0) {
          donationsGrid.innerHTML = `
            <div class="no-donations">
              <i class="fas fa-box-open" style="font-size: 3rem; color: var(--gray); margin-bottom: 15px;"></i>
              <h3>No Donations Available</h3>
              <p>There are currently no donations available. Check back later or be the first to donate!</p>
              <a href="page.html" class="btn btn-primary" style="display: inline-block; margin-top: 20px;">Make a Donation</a>
            </div>
          `;
          return;
        }

        // Display donations
        filteredDonations.forEach(donation => {
          // Log donation details for debugging
          console.log("Processing donation:", { 
            id: donation.id, 
            title: donation.title || donation.item,
            hasImage: donation.image ? 'yes' : 'no',
            imageLength: donation.image ? donation.image.length : 0,
            imageStart: donation.image ? donation.image.substring(0, 30) : 'none',
            trackingId: donation.trackingId || 'missing'
          });
          
          // Format date
          const donationDate = new Date(donation.date || Date.now());
          const formattedDate = donationDate.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          });
          
          // Determine image class based on donation type
          let imageClass = 'food-image';
          switch (donation.type) {
            case 'food':
              imageClass = 'food-image';
              break;
            case 'grocery':
              imageClass = 'grocery-image';
              break;
            case 'pet-food':
              imageClass = 'pet-food-image';
              break;
            case 'clothing':
              imageClass = 'clothing-image';
              break;
            default:
              imageClass = 'food-image';
          }
          
          // Create donation card
          const donationCard = document.createElement('div');
          donationCard.className = 'donation-card';
          
          // Check if the donation has an image
          let imageHtml = '';
          if (donation.image && typeof donation.image === 'string' && donation.image.trim().length > 0) {
            if (donation.image.startsWith('data:image')) {
              // Use the image data URL directly
              console.log(`Using custom data URL image for donation ${donation.id}`);
              imageHtml = `
                <div class="donation-image" style="background-image: url('${donation.image}');">
                  <div class="donation-badge">${(donation.type || 'Food').toUpperCase().replace('-', ' ')}</div>
                </div>
              `;
            } else {
              try {
                // Try to parse in case it's a JSON string
                let imageData = donation.image;
                if (typeof donation.image === 'string' && !donation.image.startsWith('data:')) {
                  try {
                    const parsedImage = JSON.parse(donation.image);
                    if (parsedImage && typeof parsedImage === 'string') {
                      imageData = parsedImage;
                    }
                  } catch (e) {
                    console.warn('Could not parse image data:', e);
                  }
                }
                
                if (typeof imageData === 'string' && imageData.startsWith('data:image')) {
                  console.log(`Using parsed data URL image for donation ${donation.id}`);
                  imageHtml = `
                    <div class="donation-image" style="background-image: url('${imageData}');">
                      <div class="donation-badge">${(donation.type || 'Food').toUpperCase().replace('-', ' ')}</div>
                    </div>
                  `;
                } else {
                  // Fall back to default if the data doesn't look like a valid image URL
                  console.log(`Image data doesn't appear to be a valid data URL for donation ${donation.id}, using default`);
                  imageHtml = `
                    <div class="donation-image ${imageClass}">
                      <div class="donation-badge">${(donation.type || 'Food').toUpperCase().replace('-', ' ')}</div>
                    </div>
                  `;
                }
              } catch (error) {
                console.error(`Error processing image for donation ${donation.id}:`, error);
                // Use default image class as fallback
                imageHtml = `
                  <div class="donation-image ${imageClass}">
                    <div class="donation-badge">${(donation.type || 'Food').toUpperCase().replace('-', ' ')}</div>
                  </div>
                `;
              }
            }
          } else {
            // Otherwise use default image classes
            console.log(`No image data for donation ${donation.id}, using default image class: ${imageClass}`);
            imageHtml = `
              <div class="donation-image ${imageClass}">
                <div class="donation-badge">${(donation.type || 'Food').toUpperCase().replace('-', ' ')}</div>
              </div>
            `;
          }
          
          donationCard.innerHTML = `
            ${imageHtml}
            <div class="donation-details">
              <h3>${donation.title || donation.item}</h3>
              <div class="donation-meta">
                <span><i class="fas fa-calendar-alt"></i> Added: ${formattedDate}</span>
                <span><i class="fas fa-user-shield"></i> Anonymous Donor</span>
              </div>
              <p class="donation-description">${donation.description || `${donation.quantity} units of ${donation.item}`}</p>
              <div class="donation-info">
                <div class="info-item">
                  <i class="fas fa-box"></i>
                  <span>${donation.quantity} ${donation.quantity > 1 ? 'units' : 'unit'}</span>
                </div>
                <div class="info-item">
                  <i class="fas fa-map-marker-alt"></i>
                  <span>${donation.location || donation.address || 'Various Locations'}</span>
                </div>
              </div>
              ${donation.trackingId ? `
              <div class="tracking-info">
                <div class="info-item">
                  <i class="fas fa-barcode"></i>
                  <span style="font-weight: 600; letter-spacing: 1px;">Tracking ID: ${donation.trackingId}</span>
                </div>
                <a href="/tracking?trackingId=${donation.trackingId}" style="color: var(--primary); display: block; margin-top: 5px; font-size: 0.9rem; text-decoration: none;">
                  <i class="fas fa-search"></i> Track Status
                </a>
              </div>
              ` : ''}
              <button class="request-btn" data-id="${donation.id}">Request Now</button>
            </div>
          `;
          
          // Add the card to the grid
          donationsGrid.appendChild(donationCard);
        });

        // Add event listeners for request buttons
        document.querySelectorAll('.request-btn').forEach(button => {
          button.addEventListener('click', function() {
            const donationId = this.getAttribute('data-id');
            openRequestModal(donationId);
          });
        });
      }
      
      // Modal functions
      function openRequestModal(donationId) {
        // Check if user is logged in
        if (!isLoggedIn) {
          alert('Please log in to request this donation.');
          return;
        }

        // Set the donation ID in the modal form
        document.getElementById('donationId').value = donationId;
        
        // Pre-fill requester name with current user
        if (document.getElementById('requesterName')) {
          document.getElementById('requesterName').value = currentUser;
        }
        
        // Display the modal
        modal.style.display = 'flex';
      }
      
      // Close modal button handling
      if (closeModal) {
        closeModal.addEventListener('click', function() {
          modal.style.display = 'none';
        });
      }
      
      // Filter functionality
      filterButtons.forEach(button => {
        button.addEventListener('click', function() {
          // Remove active class from all buttons
          filterButtons.forEach(btn => btn.classList.remove('active'));
          
          // Add active class to clicked button
          this.classList.add('active');
          
          // Get filter value
          const filter = this.getAttribute('data-filter').toLowerCase();
          
          // Filter donations
          if (filter === 'all') {
            filteredDonations = [...donations];
          } else {
            filteredDonations = donations.filter(donation => 
              (donation.type || '').toLowerCase().includes(filter)
            );
          }
          
          // Re-render donations
          renderDonations();
        });
      });
      
      // Search functionality
      searchBtn.addEventListener('click', handleSearch);
      
      // Search on Enter key press
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          handleSearch();
        }
      });
      
      function handleSearch() {
        const searchTerm = searchInput.value.trim().toLowerCase();
        
        if (searchTerm === '') {
          // If search is empty, reset to current filter
          if (document.querySelector('.filter-btn.active').getAttribute('data-filter') === 'all') {
            filteredDonations = [...donations];
          } else {
            const currentFilter = document.querySelector('.filter-btn.active').getAttribute('data-filter').toLowerCase();
            filteredDonations = donations.filter(donation => 
              (donation.type || '').toLowerCase().includes(currentFilter)
            );
          }
        } else {
          // Filter by search term within current filter
          filteredDonations = filteredDonations.filter(donation => 
            (donation.title || donation.item || '').toLowerCase().includes(searchTerm) ||
            (donation.description || '').toLowerCase().includes(searchTerm) ||
            (donation.donor || donation.donorName || '').toLowerCase().includes(searchTerm)
          );
        }
        
        renderDonations();
      }
      
      // Request form submission
      if (requestForm) {
        requestForm.addEventListener('submit', function(e) {
          e.preventDefault();
          
          // Hide any previous error
          hideModalError();
          
          const donationId = document.getElementById('donationId').value;
          const requesterName = document.getElementById('requesterName').value;
          const requesterEmail = document.getElementById('requesterEmail').value;
          const requesterPhone = document.getElementById('requesterPhone').value;
          const requesterMessage = document.getElementById('requesterMessage').value;
          
          // Client-side validation
          if (!requesterName) {
            showModalError('Please enter your name.');
            return;
          }
          
          if (!requesterEmail) {
            showModalError('Please enter your email address.');
            return;
          }
          
          if (!requesterPhone) {
            showModalError('Please enter your phone number.');
            return;
          }
          
          console.log('Submitting donation request:', {
            donationId,
            requesterName,
            requesterEmail,
            phoneProvided: !!requesterPhone,
            messageProvided: !!requesterMessage
          });
          
          // Show loading state
          const submitBtn = document.querySelector('.modal-submit-btn');
          const originalBtnText = submitBtn.innerHTML;
          submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending Request...';
          submitBtn.disabled = true;
          
          // Prepare request data
          const requestData = {
            donationId,
            requesterName,
            requesterEmail,
            requesterPhone,
            requesterMessage
          };
          
          // Send request to server
          fetch('/api/request-donation', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(requestData)
          })
          .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers.get('content-type'));
            
            // Get content-type to handle response appropriately
            const contentType = response.headers.get('content-type');
            
            if (response.ok) {
              // If response is OK and is JSON, parse it
              if (contentType && contentType.includes('application/json')) {
                return response.json().catch(err => {
                  console.error('Error parsing JSON from successful response:', err);
                  return { message: 'Your request has been submitted successfully!' };
                });
              }
              
              // Otherwise return a simple object with a message
              return { message: 'Your request has been submitted successfully!' };
            }
            
            // If response is not OK, handle different content types
            if (contentType && contentType.includes('application/json')) {
              return response.json().then(data => { 
                throw new Error(data.error || 'Failed to send request');
              });
            }
            
            // For HTML or other non-JSON error responses
            return response.text().then(text => {
              console.error('Non-JSON error response:', text.substring(0, 100) + '...');
              throw new Error('Server error. Please try again later.');
            });
          })
          .then(data => {
            console.log('Request successful:', data);
            
            // Close modal
            modal.style.display = 'none';
            
            // Show success message
            alert(data.message || 'Your request has been submitted successfully! The donor will be notified by email.');
            
            // Reset form
            requestForm.reset();
          })
          .catch(error => {
            console.error('Error submitting request:', error);
            
            // Show appropriate error message in the modal
            if (error.message.includes('Failed to fetch')) {
              showModalError('Network error: Please check your internet connection and try again.');
            } else {
              showModalError(error.message);
            }
          })
          .finally(() => {
            // Reset button state
            submitBtn.innerHTML = originalBtnText;
            submitBtn.disabled = false;
          });
        });
      }
      
      // Add error display to the modal HTML
      const modalContent = document.querySelector('.modal-content');
      if (modalContent) {
        // Add error container after the form description
        const formDescription = modalContent.querySelector('p');
        if (formDescription) {
          const errorContainer = document.createElement('div');
          errorContainer.className = 'error-container';
          errorContainer.style.display = 'none';
          errorContainer.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
          errorContainer.style.color = '#dc3545';
          errorContainer.style.padding = '10px 15px';
          errorContainer.style.borderRadius = '5px';
          errorContainer.style.marginBottom = '15px';
          errorContainer.style.borderLeft = '4px solid #dc3545';
          errorContainer.innerHTML = '<i class="fas fa-exclamation-circle"></i> <span class="error-message">Error message here</span>';
          
          formDescription.parentNode.insertBefore(errorContainer, formDescription.nextSibling);
        }
      }
      
      // Function to show error in the modal
      function showModalError(message) {
        const errorContainer = document.querySelector('.error-container');
        const errorMessage = document.querySelector('.error-message');
        
        if (errorContainer && errorMessage) {
          errorMessage.textContent = message;
          errorContainer.style.display = 'block';
          
          // Scroll to the top of the modal to show the error
          const modalContent = document.querySelector('.modal-content');
          if (modalContent) {
            modalContent.scrollTop = 0;
          }
        } else {
          // Fallback to alert if the error container is not found
          alert('Error: ' + message);
        }
      }
      
      // Function to hide error in the modal
      function hideModalError() {
        const errorContainer = document.querySelector('.error-container');
        if (errorContainer) {
          errorContainer.style.display = 'none';
        }
      }
      
      // Initialize the page
      fetchDonations();
    });
  </script>
</body>
</html>
